<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ConexiÃ³n RCAS Backend</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        select, button { padding: 8px; margin: 5px; }
        #log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test de ConexiÃ³n RCAS Backend</h1>
    
    <div class="test-section">
        <h3>1. Estado de la ConexiÃ³n</h3>
        <button onclick="testConnection()">ğŸ”„ Probar ConexiÃ³n</button>
        <div id="connectionStatus">Esperando prueba...</div>
    </div>
    
    <div class="test-section">
        <h3>2. Test de PaÃ­ses</h3>
        <button onclick="testCountries()">ğŸ“ Cargar PaÃ­ses</button>
        <select id="testCountrySelect">
            <option>Esperando datos...</option>
        </select>
    </div>
    
    <div class="test-section">
        <h3>3. Test de Ciudades</h3>
        <button onclick="testCities()">ğŸ™ï¸ Cargar Ciudades (PerÃº)</button>
        <select id="testCitySelect">
            <option>Esperando datos...</option>
        </select>
    </div>
    
    <div class="test-section">
        <h3>4. Test de Alertas</h3>
        <button onclick="testAlerts()">ğŸš¨ Cargar Alertas</button>
        <div id="alertsCount">Esperando datos...</div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ” Debug Base de Datos</h3>
        <button onclick="debugCitiesCount()">ğŸ”¢ Contar Ciudades de PerÃº</button>
        <button onclick="debugAllCities()">ğŸ“Š Ver Todas las Ciudades</button>
        <div id="debugResults">Esperando debug...</div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“‹ Log de Actividad</h3>
        <div id="log"></div>
        <button onclick="clearLog()">ğŸ—‘ï¸ Limpiar Log</button>
    </div>

    <script>
        const API_BASE = 'https://mi-backend-production-a259.up.railway.app/api';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = 'ğŸ”„ Probando conexiÃ³n...';
            
            try {
                log('Probando conexiÃ³n con: ' + API_BASE);
                const response = await fetch(`${API_BASE}/test/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = `<span class="success">âœ… Conectado - ${data.message}</span>`;
                    log('âœ… ConexiÃ³n exitosa: ' + JSON.stringify(data), 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">âŒ Error: ${error.message}</span>`;
                log('âŒ Error de conexiÃ³n: ' + error.message, 'error');
            }
        }
        
        async function testCountries() {
            const select = document.getElementById('testCountrySelect');
            select.innerHTML = '<option>ğŸ”„ Cargando...</option>';
            
            try {
                log('Solicitando paÃ­ses...');
                const response = await fetch(`${API_BASE}/location/countries`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const countries = await response.json();
                log(`ğŸ“ Recibidos ${countries.length} paÃ­ses`, 'success');
                
                select.innerHTML = '<option value="">Seleccionar PaÃ­s</option>';
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.id;
                    option.textContent = country.name;
                    select.appendChild(option);
                });
                
                log('âœ… PaÃ­ses cargados en selector', 'success');
                
            } catch (error) {
                select.innerHTML = '<option>âŒ Error cargando</option>';
                log('âŒ Error cargando paÃ­ses: ' + error.message, 'error');
            }
        }
        
        async function testCities() {
            const select = document.getElementById('testCitySelect');
            select.innerHTML = '<option>ğŸ”„ Cargando ciudades de PerÃº...</option>';
            
            try {
                log('Solicitando ciudades de PerÃº (ID: 1)...');
                const response = await fetch(`${API_BASE}/location/cities/1`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const cities = await response.json();
                log(`ğŸ™ï¸ Recibidas ${cities.length} ciudades`, 'success');
                
                select.innerHTML = '<option value="">Seleccionar Ciudad</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.name;
                    select.appendChild(option);
                });
                
                log('âœ… Ciudades cargadas en selector', 'success');
                
            } catch (error) {
                select.innerHTML = '<option>âŒ Error cargando</option>';
                log('âŒ Error cargando ciudades: ' + error.message, 'error');
            }
        }
        
        async function testAlerts() {
            const countDiv = document.getElementById('alertsCount');
            countDiv.innerHTML = 'ğŸ”„ Cargando alertas...';
            
            try {
                log('Solicitando alertas...');
                const response = await fetch(`${API_BASE}/alerts`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const alerts = await response.json();
                log(`ğŸš¨ Recibidas ${alerts.length} alertas`, 'success');
                
                countDiv.innerHTML = `<span class="success">âœ… ${alerts.length} alertas encontradas</span>`;
                
                if (alerts.length > 0) {
                    log('Primera alerta: ' + JSON.stringify(alerts[0]), 'info');
                }
                
            } catch (error) {
                countDiv.innerHTML = `<span class="error">âŒ Error: ${error.message}</span>`;
                log('âŒ Error cargando alertas: ' + error.message, 'error');
            }
        }
        
        async function debugCitiesCount() {
            const debugDiv = document.getElementById('debugResults');
            debugDiv.innerHTML = 'ğŸ”„ Contando ciudades...';
            
            try {
                log('Debug: Contando ciudades de PerÃº (ID: 1)...');
                const response = await fetch(`${API_BASE}/location/debug/cities-count/1`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.text();
                log('ğŸ”¢ Resultado del conteo: ' + result, 'success');
                debugDiv.innerHTML = `<span class="success">âœ… ${result}</span>`;
                
            } catch (error) {
                debugDiv.innerHTML = `<span class="error">âŒ Error: ${error.message}</span>`;
                log('âŒ Error en debug ciudades: ' + error.message, 'error');
            }
        }
        
        async function debugAllCities() {
            const debugDiv = document.getElementById('debugResults');
            debugDiv.innerHTML = 'ğŸ”„ Obteniendo estadÃ­sticas...';
            
            try {
                log('Debug: Obteniendo todas las ciudades...');
                const response = await fetch(`${API_BASE}/location/debug/all-cities`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.text();
                log('ğŸ“Š EstadÃ­sticas de ciudades: ' + result, 'success');
                debugDiv.innerHTML = `<pre class="success">${result}</pre>`;
                
            } catch (error) {
                debugDiv.innerHTML = `<span class="error">âŒ Error: ${error.message}</span>`;
                log('âŒ Error en debug estadÃ­sticas: ' + error.message, 'error');
            }
        }
        
        // Auto-test al cargar la pÃ¡gina
        window.onload = function() {
            log('ğŸš€ PÃ¡gina de pruebas cargada');
            log('ğŸ”— Backend URL: ' + API_BASE);
            testConnection();
        };
    </script>
</body>
</html>
